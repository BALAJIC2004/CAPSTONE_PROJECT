<!DOCTYPE html>
<html>

<head>
    <title>Report Leak - Jal Rakshakti</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="bi bi-droplet"></i> Jal Shakti - NRW Monitoring
                <span class="badge bg-success live-badge">LIVE</span>
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link active" href="/leaks">Report Leak</a>
                <span class="nav-link text-info">User: <%= user.name %></span>
               <a class="nav-link" href="/leaderboard"><i class="bi bi-trophy"></i> Leaderboard </a> 
                <a class="nav-link" href="/graph"><i class="bi bi-graph-up"></i> Analytics</a> 
                <a class="nav-link" href="/logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Report Water Leak</h2>
        <p class="text-muted">As a public user, you can report new water leaks in your area.</p>

        <div class="row">
            <!-- Report Form -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning">
                        <h5>Report New Leak</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/leaks/report" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label class="form-label">Select Zone</label>
                                <select class="form-select" name="zone_id" required>
                                    <option value="">Choose your area</option>
                                    <% dmaZones.forEach(zone=> { %>
                                        <option value="<%= zone.zone_id %>">
                                            <%= zone.zone_id %> - <%= zone.name %>
                                        </option>
                                        <% }); %>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Exact Location & Coordinates</label>
                                <input type="text" class="form-control" name="location" id="locationInput"
                                    placeholder="e.g., Near Main Road, Building Name, Landmark" required>
                                <div class="form-text">
                                    <button type="button" class="btn btn-outline-primary btn-sm mt-1"
                                        onclick="getCurrentLocation()">
                                        <i class="bi bi-geo-alt"></i> Use My Current Location
                                    </button>
                                    <span id="locationStatus" class="ms-2"></span>
                                </div>
                                <input type="hidden" name="latitude" id="latitude">
                                <input type="hidden" name="longitude" id="longitude">
                            </div>





                            <div class="mb-3">
                                <label class="form-label">Severity</label>
                                <select class="form-select" name="severity" required>
                                    <option value="low">Low - Small leak/dripping</option>
                                    <option value="medium">Medium - Visible water flow</option>
                                    <option value="high">High - Flooding or major damage</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description"
                                    placeholder="Describe the leak in detail, any visible damage, duration of leak..."
                                    rows="3" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="bi bi-camera-video"></i> Upload Photo/Video
                                </label>
                                <input type="file" class="form-control" name="media_file" accept="image/*,video/*">
                                <div class="form-text">
                                    Upload clear photos or videos of the leak.
                                    Supported formats: JPG, PNG, GIF, MP4, AVI, MOV (Max 50MB)
                                </div>
                            </div>
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="bi bi-send"></i> Submit Leak Report
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- My Reports -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5>My Leak Reports</h5>
                    </div>
                    <div class="card-body">
                        <% if (leaks.length> 0) { %>
                            <div class="list-group">
                                <% leaks.forEach(leak=> { %>
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">Zone: <%= leak.zone_id %>
                                            </h6>
                                            <div>
                                                <span
                                                    class="badge bg-<%= leak.status === 'fixed' ? 'success' : leak.status === 'investigating' ? 'info' : 'warning' %>">
                                                    <%= leak.status %>
                                                </span>
                                                <!-- Delete Button - FIXED -->
                                                <!-- Delete Button - FIXED -->
                                                <% if (leak.status==='reported' && leak.reported_by===user.username) {
                                                    %>
                                                    <form method="POST" action="/leaks/delete/<%= leak._id %>"
                                                        class="d-inline ms-2"
                                                        onsubmit="return confirm('Are you sure you want to delete this leak report?')">
                                                        <button type="submit" class="btn btn-danger btn-sm">
                                                            <i class="bi bi-trash"></i> Delete
                                                        </button>
                                                    </form>
                                                    <% } %>
                                            </div>
                                        </div>
                                        <p class="mb-1"><strong>Location:</strong>
                                            <%= leak.location %>
                                        </p>
                                        <p class="mb-1"><strong>Description:</strong>
                                            <%= leak.description %>
                                        </p>

                                        <!-- Show uploaded media if available -->
                                        <% if (leak.media_file) { %>
                                            <div class="mt-2">
                                                <% if (leak.media_type==='video' ) { %>
                                                    <video controls width="100%"
                                                        style="max-height: 200px; border-radius: 5px;">
                                                        <source src="<%= leak.media_file %>" type="video/mp4">
                                                        Your browser does not support the video tag.
                                                    </video>
                                                    <% } else { %>
                                                        <img src="<%= leak.media_file %>" alt="Leak evidence"
                                                            style="max-width: 100%; max-height: 200px; border-radius: 5px;">
                                                        <% } %>
                                                            <br>
                                                            <small class="text-muted">Evidence provided</small>
                                            </div>
                                            <% } %>

                                                <small class="text-muted">Reported: <%= leak.reported_date %> by <%=
                                                            leak.reported_by %></small>
                                                <% if (leak.updated_by) { %>
                                                    <br><small class="text-success">Updated by: <%= leak.updated_by %>
                                                    </small>
                                                    <% } %>

                                                        <!-- Delete status info -->
                                                        <% if (leak.status !=='reported' ) { %>
                                                            <br><small class="text-warning"><i
                                                                    class="bi bi-info-circle"></i> Cannot delete -
                                                                already in progress</small>
                                                            <% } else if (leak.reported_by !==user.username) { %>
                                                                <br><small class="text-warning"><i
                                                                        class="bi bi-info-circle"></i> Cannot delete -
                                                                    not your report</small>
                                                                <% } %>
                                    </div>
                                    <% }); %>
                            </div>
                            <% } else { %>
                                <p class="text-muted">You haven't reported any leaks yet.</p>
                                <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        function getCurrentLocation() {
            const status = document.getElementById('locationStatus');
            status.innerHTML = '<span class="text-warning">Getting location...</span>';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        console.log('Coordinates received:', lat, lng);  // <-- Added this line

                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lng;

                        // Reverse geocode to get address
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
                            .then(response => response.json())
                            .then(data => {
                                const address = data.display_name || 'Location acquired';
                                document.getElementById('locationInput').value = address;
                                status.innerHTML = '<span class="text-success">✓ Location acquired</span>';
                            })
                            .catch(error => {
                                console.error('Reverse geocoding error:', error);
                                document.getElementById('locationInput').value = `Near coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                                status.innerHTML = '<span class="text-success">✓ Coordinates acquired</span>';
                            });
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        status.innerHTML = '<span class="text-danger">❌ Location access denied. Please enter manually.</span>';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                status.innerHTML = '<span class="text-danger">❌ Geolocation not supported</span>';
            }
        }
    </script>
</body>

</html>